<html>
<head>
<link rel="stylesheet" href="style.css" type="text/css">
<script type="text/javascript" language="javascript"
	src="common-js/time.js"></script>
<script type="text/javascript" language="javascript"
	src="common-js/appletHelper.js"></script>
<script type="text/javascript" language="javascript"
	src="common-js/instalador.js"></script>
<!--<script type="text/javascript" language="javascript"
	src="common-js/cripto.js"></script>-->
<script type="text/javascript" language="javascript" src="constantes.js"></script>
<script type="text/javascript">
	
	var cipherAlgorithm="AES";
	var key;
	var keyMode='GENERATEKEY';
	var txtPlano;
	var txtCifrado;
	
	whenTry("clienteFirmaCargado == true", "clienteFirma.setCipherAlgorithm('"+cipherAlgorithm+"')", "No se ha podido iniciar el Applet de firma.");
	
						
					
			function generarKey(){
				var key=clienteFirma.getNewKey();
				clienteFirma.setKey(key);
				document.getElementById('claveActual').value=key;
			}
			
			function cifrar(){
				var ok;
				var selector=document.getElementById('selectorFuente').value;
				estableceClave(document.getElementById('claveActual').value);
				if(selector=='campo'){
					txtPlano=document.getElementById('campoTxt1').value;
					clienteFirma.setPlainData(txtPlano);
					ok=clienteFirma.cipherData();
				}else if (selector=='archivo'){
					archivo=document.getElementById('archivoFuente').value;
					alert("Cifrar "+archivo);
					ok=clienteFirma.cipherFile(archivo);
					alert(clienteFirma.saveCipherDataToFile(archivo+"-encrypted"));
				}
				txtCifrado=clienteFirma.getCipherData();
				document.getElementById('campoTxt2').value=txtCifrado;
				document.getElementById('claveActual').value=obtenerKey();
				document.getElementById('botonDescifrar').disabled='';
				if (new Boolean(ok))
					res='Ok';
				else
					res='Error'	
				actualizaInfo("Cifrado",res,clienteFirma.getCipherAlgorithm(),clienteFirma.getKeyMode(),obtenerKey());
			}
			
			function actualizaInfo(operacion,resultado,algoritmo,keymode,key){
				document.getElementById('ultimaOperacion').innerHTML=operacion+":"+resultado+" key:"+key;
				document.getElementById('algoritmoActual').innerHTML=algoritmo;
				document.getElementById('keyModeActual').innerHTML=keymode;
			}
			
			function estableceClave(clave){
				if (clienteFirma.getKeyMode()=='PASSWORD')
					clienteFirma.setPassword(clave);
				else
					clienteFirma.setKey(clave);
			}
			
			function descifrar(){
				var ok;
				var selector=document.getElementById('selectorCifrado').value;
				var clave=document.getElementById('claveActual').value;
				estableceClave(clave);
				
				if(selector=='campo'){
					var txtCifrado=document.getElementById('campoTxt2').value;
					clienteFirma.setCipherData(txtCifrado);
					var ok=clienteFirma.decipherData();
				}else if (selector=='archivo'){
					archivo=document.getElementById('archivoCifrado').value;
					//alert("Descifrar "+archivo);
					ok=clienteFirma.decipherFile(archivo);
					clienteFirma.savePlainDataToFile(archivo+".plain")
				}

				if (new Boolean(ok)) 
					res='Ok';
				else
					res='Error';
				actualizaInfo("Descifrado",res,clienteFirma.getCipherAlgorithm(),clienteFirma.getKeyMode(),obtenerKey());
				alert('Texto descifrado: '+clienteFirma.getPlainData());				
			}
			
			function obtenerAlgoritmo(){
				alert(clienteFirma.getCipherAlgorithm());
			}
			 
			function cambiaAlgoritmo(alg){
				var ok=clienteFirma.setCipherAlgorithm(alg);
				if (new Boolean(ok))
					var res='OK';
				else
					var res='Error'; 
				actualizaInfo("setCipherAlgorithm",res,clienteFirma.getCipherAlgorithm(),clienteFirma.getKeyMode(),obtenerKey());
			}
			
			function obtenerKey(){
			var res;
			if (clienteFirma.getKeyMode()=='PASSWORD'){
				res=clienteFirma.getPassword();
			}else{
				res=clienteFirma.getKey();
			}
			if (res=="undefined"||res==""||res=="null")
				return "No definida";
			else
				return res;
			}
			
			function cambiaModoDeClave(modo){
				var res=clienteFirma.setKeyMode(modo);
				if (new Boolean(res))
					res='OK';
				else
					res='Error';
				actualizaInfo("setKeyMode",res,clienteFirma.getCipherAlgorithm(),clienteFirma.getKeyMode(),obtenerKey());
			}
			
			function cambiaEnable(campo1,campo2,seleccion){
				if (seleccion=="campo"){
					document.getElementById(campo1).disabled="";
					document.getElementById(campo2).disabled="disabled";
				}else{
					document.getElementById(campo1).disabled="disabled";
					document.getElementById(campo2).disabled="";
				}
			}
			
		</script>
</head>



<body onload="cargarAppletFirma();">
<form>
<table align="center" width="40%">
	<tr>
		<td>
		<fieldset>
		<table>
			<tr>
				<td>Texto Plano<br />
					<table align="center" width="100%">
						<tr>
							<td>
								<textarea id="campoTxt1" name="textoPlano" cols="50" rows="5">Esto es una prueba</textarea>
							</td>
							<td>
								<select id="selectorFuente" onchange="cambiaEnable('campoTxt1','archivoFuente',this.value);">
									<option value="campo" selected>Campo</option>
									<option value="archivo">Archivo</option>
								</select>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<input type="file" id="archivoFuente" disabled="disabled" value="">
							</td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td>Texto Cifrado<br />
					<table align="center" width="100%">
						<tr>
							<td>
								<textarea id="campoTxt2" readonly name="textoCifrado" cols="50" rows="5"></textarea>
							</td>
							<td>
								<select id="selectorCifrado" onchange="cambiaEnable('campoTxt2','archivoCifrado',this.value);">
									<option value="campo" selected>Campo</option>
									<option value="archivo">Archivo</option>
								</select>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<input type="file" disabled="disabled" id="archivoCifrado" value="">
							</td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
		</fieldset>
		</td>
	</tr>
	<tr>
		<td>
		<fieldset>
		<table bgcolor="#D2E7FF" valign="top" align="left" width="100%">
			<tr>
				<td colspan="2" align="center" valign="top">
				<fieldset><legend>Clave</legend>
				<table>
					<tr>
						<td colspan="2" align="center"><input type="text" value=""
							id='claveActual' />
						<input type="button" value="Generar" id='botonCambiaClave' onClick="generarKey();" /></td>
					</tr>
					<tr>
						<td align="left" height="100%"><input type="radio" name="modoClave" value="GENERATEKEY" checked onClick="cambiaModoDeClave('GENERATEKEY');">AutoGenerar<br />
						<input type="radio" name="modoClave" value="USERINPUT" onClick="cambiaModoDeClave('USERINPUT');">Key Manual B64<br />
						<input type="radio" name="modoClave" value="PASSWORD" onClick="cambiaModoDeClave('PASSWORD');">Password Str<br />
						</td>
						<td><select name="algoritmo"
							onChange="cambiaAlgoritmo(this.value);">
							<option value="AES" selected>AES</option>
							<option value="CAST5">CAST5</option>
							<option value="IDEA">IDEA</option>
							<option value="TDES">TripleDES</option>
							<option value="TWOFISH">Twofish</option>
							<option value="SERPENT">Serpent</option>
						</select></td>
					</tr>
				</table>
				</fieldset>
				</td>
				<td align="center" width="20%">
				<table align="center" valign="middle">
					<tr>
						<td align="center"><input type="button" value="Cifrar" onClick="cifrar();" /><br />
						</td>
					</tr>
					<tr>
						<td align="center"><input type="button" id="botonDescifrar"
							value="Descifrar" onClick="descifrar();" /><br />
						</td>
					</tr>
					<tr>
						<td align="center"><input width="100%" type="button" value="Algoritmo actual" onClick="obtenerAlgoritmo()" /></td>
					</tr>
				</table>
				</td>
			</tr>
		</table>
		</fieldset>
		</td>
	</tr>
	<tr>
		<td colspan="2">
		<fieldset><legend>Información del criptosistema actual</legend>
		<table width="100%" align="center">
			<tr>
				<td>Algoritmo:</td>
				<td id='algoritmoActual'></td>
			</tr>
			<tr>
				<td>Modo de clave:</td>
				<td id='keyModeActual'></td>

			</tr>
			<tr>
				<td>Ultima operacion:</td>
				<td id='ultimaOperacion' colspan="2"></td>
			</tr>
		</table>
		</fieldset>
		</td>
		</tr>
		</table>
		</form></body>
</html>

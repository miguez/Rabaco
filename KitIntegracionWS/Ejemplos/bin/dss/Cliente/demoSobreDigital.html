<html>
<head>
<link rel="stylesheet" href="style.css" type="text/css">
<script type="text/javascript" language="javascript"
	src="common-js/time.js"></script>
<script type="text/javascript" language="javascript"
	src="common-js/appletHelper.js"></script>
<script type="text/javascript" language="javascript"
	src="common-js/instalador.js"></script>
<!-- <script type="text/javascript" language="javascript"
	src="common-js/cripto.js"></script> -->
<script type="text/javascript" language="javascript" src="constantes.js"></script>

<script>
		
			function crearCMSEncrypted(){
				clienteFirma.initialize();
				var alg=document.getElementById('algoritmo').value;
				clienteFirma.setCipherAlgorithm(alg);
				 
				if (document.getElementById('tipoEntrada').value=='campo'){
					var txt=document.getElementById('campoTxt1').value;
					clienteFirma.setData(txt);
				}else{
					txt=document.getElementById('archivo').value;
					clienteFirma.setFileuri(txt);
				}
				var res=clienteFirma.buildCMSEncrypted();
				if (new Boolean(res)){
					var out=clienteFirma.getCMSData();
					var key=clienteFirma.getKey();
					document.getElementById('clave').innerHTML=key;
					document.getElementById('campoTxt2').value=out;
					document.getElementById('botonFormatEnveloped').disabled='disabled';
					document.getElementById('botonFormatEncrypted').disabled='';
					document.getElementById('botonGuarda').disabled='';
					document.getElementById('file_2').disabled='';
					document.getElementById('botonRecupera1').disabled='';
					document.getElementById('botonRecupera2').disabled='';
				}else{
					document.getElementById('botonFormatEnveloped').disabled='disabled';
					document.getElementById('botonFormatEncrypted').disabled='disabled';
					document.getElementById('botonGuarda').disabled='disabled';
					document.getElementById('file_2').disabled='disabled';
					document.getElementById('botonRecupera1').disabled='disabled';
					document.getElementById('botonRecupera2').disabled='disabled';
					alert('Ha ocurrido un error');
				}
			}
			
			function crearCMSEnvelope(){
				clienteFirma.initialize();
				var alg=document.getElementById('algoritmo').value;
				clienteFirma.setCipherAlgorithm(alg);
				
				var recepts=document.getElementById('rutas').value;
				clienteFirma.setRecipientsToCMS(recepts);
				
				if (document.getElementById('tipoEntrada').value=='campo'){
					var txt=document.getElementById('campoTxt1').value;
					clienteFirma.setData(txt);
				}else{
					txt=document.getElementById('archivo').value;
					clienteFirma.setFileuri(txt);
				}
				var res=clienteFirma.buildCMSEnveloped();
				if (new Boolean(res)){
					alert("OK");
					var out=clienteFirma.getCMSData();
					document.getElementById('campoTxt2').value=out;
					document.getElementById('botonFormatEnveloped').disabled='';
					document.getElementById('botonFormatEncrypted').disabled='disabled';
					document.getElementById('botonGuarda').disabled='';
					document.getElementById('file_2').disabled='';
					document.getElementById('botonRecupera2').disabled='';
					document.getElementById('botonRecupera1').disabled='';
				}else{
					document.getElementById('botonFormatEnveloped').disabled='disabled';
					document.getElementById('botonFormatEncrypted').disabled='disabled';
					document.getElementById('botonGuarda').disabled='disabled';
					document.getElementById('file_2').disabled='disabled';
					document.getElementById('botonRecupera1').disabled='disabled';
					document.getElementById('botonRecupera2').disabled='disabled';
					alert('Ha ocurrido un error');
				}
			}
			
			function crearCMSSignAndPacket(){
				clienteFirma.initialize();
				var alg=document.getElementById('algoritmo').value;
				clienteFirma.setCipherAlgorithm(alg);
				
				var recepts=document.getElementById('rutas').value;
				clienteFirma.setRecipientsToCMS(recepts);
				if (document.getElementById('tipoEntrada').value=='campo'){
					var txt=document.getElementById('campoTxt1').value;
					clienteFirma.setData(txt);
					var res=clienteFirma.signAndPackData();
				}else{
					txt=document.getElementById('archivo').value;
					var res=clienteFirma.signAndPackFile(txt);
				}
				if (new Boolean(res)){
					var out=clienteFirma.getCMSData();
					document.getElementById('campoTxt2').value=out;
					document.getElementById('botonFormatEnveloped').disabled='';
					document.getElementById('botonFormatEncrypted').disabled='disabled';
					document.getElementById('botonGuarda').disabled='';
					document.getElementById('file_2').disabled='';
					document.getElementById('botonRecupera1').disabled='';
					document.getElementById('botonRecupera2').disabled='';
				}else{
					document.getElementById('botonFormatEnveloped').disabled='disabled';
					document.getElementById('botonFormatEncrypted').disabled='disabled';
					document.getElementById('botonGuarda').disabled='disabled';
					document.getElementById('file_2').disabled='disabled';
					document.getElementById('botonRecupera1').disabled='disabled';
					document.getElementById('botonRecupera2').disabled='disabled';
					alert('Ha ocurrido un error');
				}
			}
			
			function recuperarEncryptedCMS(){
				var x=document.getElementById("campoTxt2").value;
				clienteFirma.setData(x);
				if(clienteFirma.recoverCMS()){
					var o=clienteFirma.getData();
					var w=window.open("","1");
					w.document.write("<b>TEXTO RECUPERADO: </b>"+o);
				}else{
					alert("Ha ocurrido un error");
				}
			}
			
			function recuperarEnvelopedCMS(){
				var x=document.getElementById("campoTxt2").value;
				clienteFirma.setData(x);
				if(clienteFirma.recoverCMS()){
					var o=clienteFirma.getData();
					var w=window.open("","1");
					w.document.write("<b>TEXTO RECUPERADO: </b>"+o);
				}else{
					alert("Ha ocurrido un error");
				}
			}
			function addCert(uri){
				var ext=uri.substring(uri.lastIndexOf('.'),uri.length);
				if (ext==".cer" || ext==".der" || ext==".CER" || ext==".DER"){
					var x=document.getElementById("rutas");
					x.value=x.value+uri+"\n";
					document.getElementById('botonCarga2').disabled='';
					document.getElementById('botonCarga3').disabled='';
				}else{
					alert("No se ha elegido un CER o DER válido.");
				}
			}
			
			function guardar(){
				
				var file=document.getElementById("file_2").value;
				if (file==undefined||file==""){
					clienteFirma.saveDataToFile();
				}else{
					clienteFirma.saveDataToFile(file);
				}
			}
			
			function formatEncrypted(){
				var x=document.getElementById("campoTxt2").value;
				var o=clienteFirma.formatEncryptedCMS(x);
				var w=window.open("","1");
				w.document.write(o);
			}
			
			function formatEnveloped(){
				var x=document.getElementById("campoTxt2").value;
				var o=clienteFirma.formatEnvelopedCMS(x);
				var w=window.open("","1");
				w.document.write(o);
			}
			
			function cambiaEntrada(campo){
				document.getElementById('tipoEntrada').value=campo;
				if (campo=='campo'){
					document.getElementById('campoTxt1').disabled='';
					document.getElementById('archivo').disabled='disabled';
				}else{
					document.getElementById('campoTxt1').disabled='disabled';
					document.getElementById('archivo').disabled='';				
				}
			}
			
		</script>
</head>

<body onload="cargarAppletFirma();">
<form><input type="hidden" name="receipts" id="idReceipts" value="">
<input type="hidden" id="tipoEntrada" value="campo"/>
	<p style="font-weight:bold;font-size:16pt;" align="center">Demostración de sobre digital</p>
<table align="center" width="40%">
	<tr>
		<td align="center">
			
		<fieldset>
		<table align="center">
			<tr>
				<td>
				<fieldset>
				<table>
					<tr>
						<td colspan="2"><input type="radio" name="entrada" value="campo" checked="checked" onClick="cambiaEntrada(this.value);" /> Texto Plano<br />
						<textarea id="campoTxt1" name="contenido" cols="50" rows="5">Esto es una prueba</textarea></td>
					</tr>
					<tr>
						<td colspan="2"><input type="radio" name="entrada" value="archivo" onClick="cambiaEntrada(this.value);"/>Archivo 
						<input type="file" id="archivo" disabled="disabled" size="35"/></td>
					</tr>
					<tr>
						<td colspan="2">Resultado<br />
						<textarea id="campoTxt2" name="textoCMS" cols="50" rows="5"></textarea></td>
					</tr>
					<tr>
						<td>Clave: <label id='clave'></label></td>
						<td>Algoritmo simétrico: <select id="algoritmo">
							<option selected value="AES">AES</option>
							<option value="CAST5">CAST.5</option>
							<option value="IDEA">IDEA</option>
							<option value="TDES">Triple DES</option>
							<option value="RC5">RC5</option>
						</select>
					</tr>
				</table>
				</fieldset>
				</td>
			</tr>
			<tr>
				<td>
				<table weight="100%">
					<tr>
						<td>
						<table width="100%">
							<tr>
								<td>
								<table>
									<tr>
										<td colspan="2">
										<table valign="top" align="center">
											<tr>
												<td align="center"><input type="button" id="botonCarga1"
													value="CMS encriptado" onClick="crearCMSEncrypted();"></td>
											</tr>
											<tr>
												<td align="center"><input disabled='disabled' type="button"
													id="botonCarga2" value="CMS envuelto"
													onClick="crearCMSEnvelope();"></td>
											</tr>
											<tr>
												<td align="center"><input disabled='disabled' type="button"
													id="botonCarga3" value="'Sign & Packet'"
													onClick="crearCMSSignAndPacket();"></td>
											</tr>
										</table>
										</td>
									</tr>
								</table>
								</td>
								<td valign="top" height="100%">
								<table>
									<tr>
										<td colspan="2">
										<table valign="top" height="100%" align="center">
											<tr>
												<td align="center"><input type="button"
													id="botonFormatEncrypted" value="Formatear encriptado"
													disabled='disabled' onClick="formatEncrypted();"></td>
											</tr>
											<tr>
												<td align="center"><input type="button"
													id="botonFormatEnveloped" value="Formatear sobre"
													disabled='disabled' onClick="formatEnveloped();"></td>
											</tr>
											<tr>
												<td align="center"><input type="button"
													id="botonRecupera1" value="Rec. Enveloped"
													disabled='disabled' onClick="recuperarEncryptedCMS();">
													<input type="button"
													id="botonRecupera2" value="Rec. Encripted"
													disabled='disabled' onClick="recuperarEnvelopedCMS();">
													</td>
											</tr>
											</table>
										</td>
									</tr>
								</table>
								</td>
							</tr>
							<tr>
								<td align="center" colspan="2">Fichero salida:
								<input type="text" id="file_2" size="48" disabled="disabled"/>
								<input type="button" id="botonGuarda" value="Guardar resultado" disabled='disabled' onClick="guardar();"/>
								
								</td>
							</tr>
						</table>
						</td>
					</tr>
					<tr>
						<td>
						<fieldset><legend>Receptores (archivos .cer o .der)</legend>
						<table weight="100%" id="fileSelector">
							<tr>
								<td weight="100%"><input accept="application/pkix-cert,application/x-x509-ca-cert" type="file" id="file_1" size="32" name="ficheroCert">
								<input type="button" id="addCertificado" onClick="addCert(document.getElementById('file_1').value);" value="Añadir ruta"></td>
							</tr>
							<tr>
								<td><textarea id="rutas" readonly cols="50" rows="5" wrap="off"></textarea>
								</td>
							</tr>
						</table>
						</fieldset>
						</td>
					</tr>
				</table>
				</td>
			</tr>
		</table>
		</fieldset>
		</td>
	</tr>
</table>
</form>
</body>
</html>

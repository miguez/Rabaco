.. _interfaz-http:

=================
 Interfaz *HTTP*
=================

Recolección
===========

Las operaciones relacionadas con el descubrimiento de colecciones y la recolección (*harvesting*) de los datos pertenecientes
a las mismas se efectúan siguiendo la recomendación del grupo de trabajo *WS/eGov-Share del Comité Européen de
Normalisation*.

Este protocolo define la estructura de fuentes web de tipo *Atom* publicada por un servidor para exponer una o más
colecciones, especificando cuatro tipos distintos de fuente web necesarios para definir una colección determinada.

.. figure:: /images/sdshare/feeds.png
  :scale: 75%
  :align: center

**Overview feed**
  El overview feed permite el descubrimiento de las distintas colecciones que maneja el servidor. Se encuentra localizado en
  la url ``/icms/sdshare/``, y se accede a él mediante una operación de tipo *http get* sin parámetros.

**Collection feed**
  Un collection feed es una fuente web asociada a una colección de descripciones semánticas determinada que contiene
  exactamente dos entradas, una enlazando con el *snapshots feed* y otra que hace lo propio con el *fragments feed*.

  El *collection feed* de una colección se puede encontrar bajo la *url* ``/icms/sdshare/<identificador de colección>``

**Snapshots feed**
  Un *snapshots feed* enlaza con uno o varios *snapshots* o instantáneas, que representan el estado de una colección en un
  momento determinado.

  El *snapshots feed* correspondiente a una colección con un identificador colección estará
  disponible bajo la *url* ``/icms/sdshare/<identificador de colección colección>/snapshots``

**Snapshots**
  Los *snapshots* son representaciones de la colección en *rdf+xml*, accesibles en la *url* ``/icms/sdshare/<identificador
  de la colección>/snapshots/<identificador del snapshot>``

**Fragments feed**
  El *fragments feed* es una fuente web de tipo *Atom*, al igual que las anteriores, cuyas entradas enlazan con fragmentos, que
  son representaciones de los cambios que se realizan en una colección a lo largo del tiempo.

  La dirección desde la que se puede acceder al *fragments feed* es
  ``/icms/sdshare/<colección>/fragments``

**Fragments**
  Al igual que ocurre con los *snapshots*, los fragmentos se describirán mediante *rdf+xml*, y están
  representados tanto en el *fragments feed* como en el espacio de *uris*, accesibles bajo
  ``/icms/sdshare/fragments/<identificador del fragment>``

Búsqueda
========

Como paso previo a una consulta, se supone al sistema cliente un conocimiento de las distintas
colecciones existentes en el sistema destino de la petición de búsqueda, conocimiento derivado de
una operación de recolección anterior. Cada una de estas colecciones tiene asociada un fichero
descriptor de la búsqueda que indica al cliente los parámetros que debe o puede incluir en la
petición de consulta.

Las peticiones de búsqueda son como la siguiente
``/icms/feeds/coleccion?parametro="valor"&<...>``

Además de los parámetros específicos para cada tipo de contenido que se está buscando (relacionados con los meta-datos
que dicho tipo de contenido admite), en la petición se pueden incluir parámetros destinados a la configuración y control de la
paginación en el documento de respuesta. En concreto, son:

items
  Define el número de elementos incluidos por cada página del documento de respuesta.
page
  Define la página de resultados deseada.

La *url* base para acceder a las colecciones es ``/icms/feeds/`` A partir de ahí, el resto de la dirección identifica
unívocamente una de las posibles colecciones contenidas en el sistema servidor. Como ya se ha especificado
anteriormente, la *url* de una colección se utiliza para efectuar consultas mediante el protocolo *OpenSearch*, pasando como
parámetros las condiciones de la búsqueda.

Por último, el sistema *iCMS* servidor está encargado de la publicación de los descriptores de
búsqueda *OpenSearch* que definen sus capacidades de consulta. Estos descriptores se encuentran bajo
la *url* ``/icms/opensearch/``, siendo
identificados en última instancia por el nombre de la colección a la que pertenecen (por ejemplo
``/icms/opensearch/<coleccion>``).

Suscripción y notificación
==========================

Suscripción simple
------------------

Suponiendo un cliente que quiere suscribirse a una colección determinada, el cliente realizará una
petición *HTTP* a la dirección ``/icms/subscribe/<identificador de colección>``, pasando como
argumento de la petición una dirección de callback (utilizando el parámetro *url*) en la cual
desea recibir las notificaciones del servidor.

Es necesario pues, que el sistema que se suscribe tenga disponible un servicio al que le llegarán
los mensajes que envía el servidor *iCMS* con cada cambio en la colección. El formato de estos
mensajes es una petición *HTTP POST* que incluye, descrito mediante un *xml Atom*, un enlace al recurso
que describe el cambio::

  POST / HTTP/1.1
  Content-Type: application/atom+xml
  User-Agent: Jakarta Commons-HttpClient/3.1
  Host: localhost:3333
  Content-Length: 316

  <entry xmlns="http://www.w3.org/2005/Atom">
    <id>http://192.168.10.101:9991/icms/id/exampleIcmsCollection/ID1254818358233</id>
    <updated>Tue Oct 06 10:39:18 CEST 2009</updated>
    <link rel="alternate" type="application/rdf+xml"
      href="http://192.168.10.101:9991/icms/id/exampleIcmsCollection/ID1254818358233"/>
  </entry>

.. note::
  El contenido de la notificación no es el cambio en sí, sino el enlace al recurso que ha sido
  modificado, siendo responsabilidad del sistema notificado la petición posterior del mismo.

Suscripción con condiciones
---------------------------

Una funcionalidad interesante del sistema de suscripción y notificación de la *Interfaz de
Interoperabilidad* es la posibilidad de definir un conjunto de condiciones asociadas. De esta
manera, el servidor sólo manda avisos de notificación de cambios en los contenidos si se cumplen una
serie de requisitos en el recurso correspondiente al cambio.

Las condiciones se especifican como un parámetro más en la petición *HTTP* de suscripción. Por
ejemplo, para recibir notificaciones de la colección ``ejemplo`` sólo si se cumplen ciertas
condiciones referentes a los metadatos ``dc:subject`` y ``dc:creator`` del recurso, se realizaría una
petición similar a ::

  "http://www.juntadeandalucia.es/icms/susbcribe/ejemplo?
    conditions=dc:subject=noticia;dc:creator=usuario&url=http://10.0.0.2:3000"

Cancelar una suscripción
------------------------

Para cancelar una suscripción, se manda una petición *HTTP* a la *url* ``/icms/unsubscribe/<identificador
de la colección>`` incluyendo, al igual que en el caso de la suscripción, la *url* destino de las
notificaciones como parámetro. En el caso de que queramos cancelar una suscripción con condiciones
se añadirá las condiciones para las cuales se ha suscrito, similar al proceso de suscripción con
condiciones.
